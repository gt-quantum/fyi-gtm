---
import BaseLayout from '../../layouts/BaseLayout.astro';
import NewsletterList from '../../components/newsletter/NewsletterList.jsx';
---

<BaseLayout title="Newsletter | FYI GTM">
  <div class="container">
    <!-- Hero Section -->
    <section class="hero">
      <h1 class="hero-title">Newsletter</h1>
      <p class="hero-subtitle">
        Browse past issues of our weekly go-to-market intelligence newsletter.
      </p>
    </section>

    <!-- Subscribe Bar -->
    <div class="subscribe-wrapper">
      <form class="subscribe-form" id="newsletter-form">
        <input
          type="email"
          placeholder="Enter your email"
          class="subscribe-input"
          id="newsletter-email"
          required
        />
        <button type="submit" class="subscribe-button" id="newsletter-submit">
          Subscribe
        </button>
      </form>
      <p class="newsletter-status" id="newsletter-status"></p>
    </div>

    <!-- Main Content (Full Width) -->
    <div class="main-layout">
      <NewsletterList client:load />
    </div>
  </div>
</BaseLayout>

<style>
  .container {
    max-width: var(--container-max-width);
    margin: 0 auto;
    padding: 0 var(--content-padding);
  }

  /* Hero */
  .hero {
    text-align: center;
    padding: 32px 0 24px;
  }

  .hero-title {
    font-size: 2.5rem;
    font-weight: 600;
    margin: 0 0 8px;
    color: var(--color-text);
    letter-spacing: -0.03em;
  }

  .hero-subtitle {
    font-size: 1rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Subscribe Bar */
  .subscribe-wrapper {
    margin-bottom: 24px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .subscribe-form {
    display: flex;
    gap: 0;
  }

  .subscribe-input {
    flex: 1;
    padding: 14px 16px;
    border: 1px solid var(--color-border);
    background-color: var(--color-background-secondary);
    color: var(--color-text);
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s ease;
    border-radius: 8px 0 0 8px;
  }

  .subscribe-input::placeholder {
    color: var(--color-text-muted);
  }

  .subscribe-input:focus {
    border-color: var(--color-text);
    background: var(--color-background-tertiary);
  }

  .subscribe-button {
    padding: 14px 24px;
    background-color: var(--color-text);
    color: var(--color-background);
    border: 1px solid var(--color-text);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 0 8px 8px 0;
  }

  .subscribe-button:hover {
    background-color: transparent;
    color: var(--color-text);
  }

  .subscribe-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .newsletter-status {
    margin-top: 12px;
    font-size: 0.875rem;
    min-height: 1.25em;
    text-align: center;
  }

  .newsletter-status.success {
    color: #10B981;
  }

  .newsletter-status.error {
    color: #EF4444;
  }

  /* Full Width Layout (no sidebar) - centered */
  .main-layout {
    display: block;
    max-width: 800px;
    margin: 0 auto;
  }

  @media (max-width: 768px) {
    .hero-title {
      font-size: 1.75rem;
    }

    .subscribe-form {
      flex-direction: column;
      gap: 12px;
    }

    .subscribe-input {
      border-radius: 8px;
    }

    .subscribe-button {
      border-radius: 8px;
    }
  }
</style>

<script>
  const form = document.getElementById('newsletter-form');
  const emailInput = document.getElementById('newsletter-email') as HTMLInputElement;
  const submitBtn = document.getElementById('newsletter-submit') as HTMLButtonElement;
  const statusEl = document.getElementById('newsletter-status');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = emailInput?.value?.trim();
    if (!email) return;

    // Update UI for loading state
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Subscribing...';
    }
    if (statusEl) {
      statusEl.textContent = '';
      statusEl.className = 'newsletter-status';
    }

    try {
      const response = await fetch('/api/newsletter/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (response.ok) {
        if (statusEl) {
          statusEl.textContent = 'Thanks for subscribing!';
          statusEl.className = 'newsletter-status success';
        }
        if (emailInput) emailInput.value = '';
      } else {
        throw new Error(data.error || 'Failed to subscribe');
      }
    } catch (error) {
      if (statusEl) {
        statusEl.textContent = 'Something went wrong. Please try again.';
        statusEl.className = 'newsletter-status error';
      }
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
      }
    }
  });
</script>
